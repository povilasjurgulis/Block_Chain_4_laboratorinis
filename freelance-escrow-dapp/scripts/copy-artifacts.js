// scripts/copy-artifacts.js
const fs = require("fs");
const path = require("path");

// 1. Iš kur paimam truffle artefaktą
const artifactPath = path.join(
  __dirname,
  "..",
  "build",
  "contracts",
  "FreelanceEscrow.json"
);

// 2. Kur į client'ą jį kopijuojam
const clientContractsDir = path.join(
  __dirname,
  "..",
  "client",
  "src",
  "contracts"
);
const clientArtifactPath = path.join(
  clientContractsDir,
  "FreelanceEscrow.json"
);

// 3. Kur generuosim configą su NETWORK_ID ir CONTRACT_ADDRESS
const escrowConfigPath = path.join(
  __dirname,
  "..",
  "client",
  "src",
  "escrowConfig.js"
);

// ---- Logika ----

const artifact = JSON.parse(fs.readFileSync(artifactPath, "utf8"));

const networks = artifact.networks || {};
const networkIds = Object.keys(networks);

if (networkIds.length === 0) {
  throw new Error("FreelanceEscrow.json neturi jokių 'networks' – ar paleidai truffle migrate?");
}

// Use network_id 1337 (Ganache chainId)
let latestNetworkId = "1337";

// If 1337 doesn't exist, fall back to the latest deployed network
if (!networks[latestNetworkId]) {
  latestNetworkId = networkIds
    .map(Number)
    .sort((a, b) => a - b)
    .pop()
    .toString();
}

const address = networks[latestNetworkId].address.toLowerCase();

// užtikrinam, kad client/src/contracts egzistuoja
fs.mkdirSync(clientContractsDir, { recursive: true });

// nukopijuojam visą artefaktą į clientą
fs.writeFileSync(clientArtifactPath, JSON.stringify(artifact, null, 2));

// sugeneruojam escrowConfig.js
const configContent = `// Auto-generated by scripts/copy-artifacts.js
export const NETWORK_ID = "${latestNetworkId}";
export const CONTRACT_ADDRESS = "${address}";
`;

fs.writeFileSync(escrowConfigPath, configContent);

console.log("   Artifacts nukopijuoti:");
console.log("   NETWORK_ID =", latestNetworkId);
console.log("   CONTRACT_ADDRESS =", address);
